<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Afacad+Flux:slnt,wght@1,100..1000&family=Merienda:wght@300..900&family=Pacifico&display=swap" rel="stylesheet">
    <title>Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>

<body>
    <nav id="nav_bar" class="navBar">
        <a href="#top" id="logo">CouponHub</a>

        <div class="input-wrapper">
            <input type="text" class="search-icon" placeholder="Start searching here...">
            <span class="tune-icon"></span>
        </div>

        <div class="icon-container">
            <button id="toggleSwitch" class="lightMode icon"></button>
            <a href="#" class="notification icon"></a>
            <a href="#" class="setting icon"></a>
            <div class="user icon" onclick="toggleMenu()">
                <ul class="usersData" id="menu">
                    <li><a href="/Frontend/profile.html">Profile</a></li>
                    <li><a href="/Frontend/collection.html">Collection</a></li>
                    <li><a href="#">History</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="addCoupon">
        <button class="addCoupon" onclick="openPopup()">Add Coupon +</button>
    </div>

    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <button class="popup-close" onclick="closePopup()">&times;</button>
            <h2>Add Coupon</h2>
            <form id="addCouponForm" enctype="multipart/form-data" onsubmit="return handleCouponSubmit(event)">
                <input type="text" id="couponName" name="name" placeholder="Coupon Name" required>
                <input type="text" id="couponPlace" name="place" placeholder="Place" required>
                <label for="expiryDate" class="ExpiryDate">Expiry Date</label>
                <input type="date" id="expiryDate" name="expiryDate" required>
                <input type="text" id="couponOwner" name="owner" placeholder="Owner" required>
                <input type="file" id="couponImage" name="image" accept="image/*" >
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const popupOverlay = document.getElementById('popupOverlay');

        function openPopup() {
            popupOverlay.style.display = 'flex';
        }

        function closePopup() {
            popupOverlay.style.display = 'none';
        }
        async function handleCouponSubmit(event) {
    event.preventDefault();

    try {
        const form = document.getElementById('addCouponForm');
        const formData = new FormData(form);

        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            showToast("Please login first", "error");
            return false;
        }

        // Log form data for debugging
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        const response = await fetch('http://localhost:8000/api/v1/coupons', {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });

        // Log the full response for debugging
        // console.log('Response status:', response.status);
        
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            console.log('Response data:', data);

            if (response.status === 201) {
                showToast("Coupon added successfully!", "success");
                form.reset();
                closePopup();
            } else {
                showToast(data.message || "Failed to add coupon", "error");
            }
        } else {
            console.error('Received non-JSON response');
            showToast("Unexpected server response", "error");
        }

    } catch (error) {
        console.error("Error submitting form:", error);
        showToast("An error occurred. Please try again.", "error");
    }
    return false;
}

// Update the showToast function
function showToast(message, type) {
    try {
        console.log('Attempting to show toast:', message, type);
        
        if (typeof Toastify !== 'function') {
            console.error('Toastify is not loaded!');
            alert(message); // Fallback
            return;
        }

        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: type === "success" ? "#4caf50" : "#f44336",
            stopOnFocus: true,
            onClick: function(){} // Callback after click
        }).showToast();
        
        // console.log('Toast shown successfully');
    } catch (error) {
        console.error('Error showing toast:', error);
        alert(message); // Fallback
    }
}
    </script>
</body>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="dashboard.js"></script>
</html>
